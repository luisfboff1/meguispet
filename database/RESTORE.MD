# üîÑ Guia de Restore do Banco de Dados - MeguisPet

Este guia explica como restaurar backups do banco de dados PostgreSQL (Supabase) do sistema MeguisPet.

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Pr√©-requisitos](#pr√©-requisitos)
- [Tipos de Restore](#tipos-de-restore)
- [Restore Automatizado](#restore-automatizado)
- [Restore Manual](#restore-manual)
- [Cen√°rios Comuns](#cen√°rios-comuns)
- [Troubleshooting](#troubleshooting)
- [Seguran√ßa](#seguran√ßa)

---

## üéØ Vis√£o Geral

O sistema de backup do MeguisPet gera 6 arquivos por execu√ß√£o:

### Schema `public` (Dados do ERP)
- **`meguispet_full_*.sql`** - Backup completo (estrutura + dados)
- **`meguispet_structure_*.sql`** - Apenas estrutura (tabelas, √≠ndices, constraints)
- **`meguispet_data_*.sql`** - Apenas dados (INSERT statements)

### Schema `auth` (Autentica√ß√£o Supabase)
- **`auth_full_*.sql`** - Backup completo do schema auth
- **`auth_structure_*.sql`** - Apenas estrutura do schema auth
- **`auth_data_*.sql`** - Apenas dados do schema auth (usu√°rios, senhas, sess√µes)

---

## ‚úÖ Pr√©-requisitos

### 1. PostgreSQL Client Tools
- **Vers√£o recomendada**: PostgreSQL 18 (compat√≠vel com Supabase 17.6)
- **Caminho no Windows**: `C:\Program Files\PostgreSQL\18\bin`
- **Ferramentas necess√°rias**: `psql`, `pg_restore`, `pg_dump`

### 2. Credenciais do Supabase
```bash
DB_HOST=aws-1-sa-east-1.pooler.supabase.com
DB_PORT=6543
DB_NAME=postgres
DB_USER=postgres.jsitmcqabchjidoezycj
PGPASSWORD=yMI6QwcNfQpIKYje
```

### 3. Backup V√°lido
- Localize o diret√≥rio de backup (ex: `backup\2025_01_29_143022\`)
- Verifique se os arquivos `.sql` existem e n√£o est√£o corrompidos
- Confirme o timestamp do backup que deseja restaurar

---

## üîÄ Tipos de Restore

### 1. **Restore Completo (Full)**
Restaura estrutura + dados em um banco limpo.

**Quando usar:**
- Restaura√ß√£o completa ap√≥s desastre
- Migra√ß√£o para novo ambiente
- Cria√ß√£o de ambiente de desenvolvimento

**Arquivos usados:**
- `meguispet_full_*.sql`
- `auth_full_*.sql`

---

### 2. **Restore Apenas Estrutura (Structure)**
Recria tabelas, √≠ndices, constraints, sem dados.

**Quando usar:**
- Criar ambiente de testes vazio
- Sincronizar estrutura entre ambientes
- Corrigir estrutura corrompida mantendo dados

**Arquivos usados:**
- `meguispet_structure_*.sql`
- `auth_structure_*.sql`

---

### 3. **Restore Apenas Dados (Data)**
Insere dados em estrutura existente.

**Quando usar:**
- Restaurar dados deletados acidentalmente
- Popular ambiente de desenvolvimento
- Sincronizar dados entre ambientes

**‚ö†Ô∏è ATEN√á√ÉO:** Requer estrutura id√™ntica j√° existente!

**Arquivos usados:**
- `meguispet_data_*.sql`
- `auth_data_*.sql`

---

## ü§ñ Restore Automatizado

### Op√ß√£o 1: Script `restore.bat` (Recomendado)

```batch
cd database
.\restore.bat
```

O script ir√°:
1. Listar todos os backups dispon√≠veis
2. Solicitar qual backup restaurar (timestamp)
3. Perguntar qual tipo de restore (completo/estrutura/dados)
4. Confirmar antes de executar
5. Executar o restore com valida√ß√µes

### Op√ß√£o 2: Restore Completo R√°pido

```batch
cd database
.\restore.bat 2025_01_29_143022 full
```

Par√¢metros:
- `2025_01_29_143022` - Timestamp do backup
- `full` - Tipo de restore (full | structure | data)

---

## üõ†Ô∏è Restore Manual

### Passo 1: Preparar o Ambiente

```batch
@REM Adicionar PostgreSQL ao PATH
set PATH=C:\Program Files\PostgreSQL\18\bin;%PATH%

@REM Configurar credenciais
set DB_HOST=aws-1-sa-east-1.pooler.supabase.com
set DB_PORT=6543
set DB_NAME=postgres
set DB_USER=postgres.jsitmcqabchjidoezycj
set PGPASSWORD=yMI6QwcNfQpIKYje

@REM Definir timestamp do backup
set TIMESTAMP=2025_01_29_143022
set BACKUP_DIR=backup\%TIMESTAMP%
```

---

### Passo 2: Escolher o Tipo de Restore

#### A) Restore Completo (Full)

**‚ö†Ô∏è CUIDADO: Isso ir√° DROPAR e RECRIAR schemas existentes!**

```batch
@REM Restore schema public
psql -h %DB_HOST% -p %DB_PORT% -U %DB_USER% -d %DB_NAME% -f "%BACKUP_DIR%\meguispet_full_%TIMESTAMP%.sql"

@REM Restore schema auth
psql -h %DB_HOST% -p %DB_PORT% -U %DB_USER% -d %DB_NAME% -f "%BACKUP_DIR%\auth_full_%TIMESTAMP%.sql"
```

---

#### B) Restore Apenas Estrutura

**‚ö†Ô∏è √ötil para criar ambiente vazio ou recriar estrutura**

```batch
@REM Restore estrutura do schema public
psql -h %DB_HOST% -p %DB_PORT% -U %DB_USER% -d %DB_NAME% -f "%BACKUP_DIR%\meguispet_structure_%TIMESTAMP%.sql"

@REM Restore estrutura do schema auth
psql -h %DB_HOST% -p %DB_PORT% -U %DB_USER% -d %DB_NAME% -f "%BACKUP_DIR%\auth_structure_%TIMESTAMP%.sql"
```

---

#### C) Restore Apenas Dados

**‚ö†Ô∏è REQUISITO: Estrutura id√™ntica j√° deve existir!**

```batch
@REM Restore dados do schema public
psql -h %DB_HOST% -p %DB_PORT% -U %DB_USER% -d %DB_NAME% -f "%BACKUP_DIR%\meguispet_data_%TIMESTAMP%.sql"

@REM Restore dados do schema auth
psql -h %DB_HOST% -p %DB_PORT% -U %DB_USER% -d %DB_NAME% -f "%BACKUP_DIR%\auth_data_%TIMESTAMP%.sql"
```

---

## üé¨ Cen√°rios Comuns

### Cen√°rio 1: Restaura√ß√£o Completa de Desastre

**Situa√ß√£o:** Banco de dados corrompido ou perdido completamente.

**Solu√ß√£o:**
```batch
cd database
.\restore.bat

@REM Siga as instru√ß√µes:
@REM 1. Escolha o backup mais recente
@REM 2. Selecione "full" (restaura√ß√£o completa)
@REM 3. Confirme a opera√ß√£o
```

**Tempo estimado:** 5-15 minutos (depende do tamanho do banco)

---

### Cen√°rio 2: Recuperar Dados Deletados Acidentalmente

**Situa√ß√£o:** Dados foram deletados por engano, mas estrutura est√° intacta.

**Op√ß√£o A - Restore seletivo (Recomendado):**
```sql
-- Conectar ao banco
psql -h %DB_HOST% -p %DB_PORT% -U %DB_USER% -d %DB_NAME%

-- Restaurar apenas a tabela afetada do backup
\i backup\2025_01_29_143022\meguispet_data_2025_01_29_143022.sql

-- ‚ö†Ô∏è Isso pode causar conflitos de chaves prim√°rias!
-- Considere fazer backup antes de tentar
```

**Op√ß√£o B - Restore em banco tempor√°rio:**
1. Crie um banco tempor√°rio
2. Restaure o backup completo l√°
3. Copie apenas os dados necess√°rios
4. Delete o banco tempor√°rio

---

### Cen√°rio 3: Sincronizar Ambiente de Desenvolvimento

**Situa√ß√£o:** Precisa de uma c√≥pia dos dados de produ√ß√£o para desenvolvimento.

**Solu√ß√£o:**
```batch
@REM 1. Fa√ßa backup de produ√ß√£o
cd database
.\backup-complete.bat

@REM 2. Configure credenciais de DEV
set DB_HOST=seu-projeto-dev.supabase.co
set DB_USER=postgres.dev_user
set PGPASSWORD=dev_password

@REM 3. Restaure o backup
.\restore.bat 2025_01_29_143022 full
```

**‚ö†Ô∏è IMPORTANTE:**
- Sanitize dados sens√≠veis antes de usar em DEV
- N√£o exponha senhas reais de usu√°rios
- Considere mascarar CPF/CNPJ, emails, telefones

---

### Cen√°rio 4: Rollback de Migration Falha

**Situa√ß√£o:** Uma migration corrompeu o schema.

**Solu√ß√£o:**
```batch
@REM 1. Restaure apenas a estrutura do backup anterior
.\restore.bat 2025_01_29_120000 structure

@REM 2. Verifique se a estrutura foi restaurada
psql -h %DB_HOST% -p %DB_PORT% -U %DB_USER% -d %DB_NAME% -c "\dt public.*"

@REM 3. Se necess√°rio, restaure tamb√©m os dados
.\restore.bat 2025_01_29_120000 data
```

---

## üîß Troubleshooting

### Erro: "psql: command not found"

**Causa:** PostgreSQL n√£o est√° no PATH.

**Solu√ß√£o:**
```batch
set PATH=C:\Program Files\PostgreSQL\18\bin;%PATH%
```

Ou adicione permanentemente nas Vari√°veis de Ambiente do Windows.

---

### Erro: "FATAL: password authentication failed"

**Causa:** Senha incorreta ou expirada.

**Solu√ß√£o:**
1. Verifique a senha no Supabase Dashboard
2. Atualize a vari√°vel `PGPASSWORD` no script
3. Se estiver usando `.pgpass`, verifique o formato

---

### Erro: "relation already exists"

**Causa:** Tentando restaurar estrutura em banco que j√° possui as tabelas.

**Solu√ß√£o:**

**Op√ß√£o A - Limpar antes (CUIDADO!):**
```sql
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO public;
```

**Op√ß√£o B - Restaurar apenas dados:**
```batch
.\restore.bat 2025_01_29_143022 data
```

---

### Erro: "permission denied for schema auth"

**Causa:** Schema `auth` √© gerenciado pelo Supabase e requer permiss√µes especiais.

**Solu√ß√£o:**
1. Use a **Service Role Key** (n√£o a anon key)
2. Conecte com o usu√°rio `postgres` (n√£o usu√°rios comuns)
3. Se necess√°rio, pe√ßa suporte ao Supabase para restore do schema auth

**‚ö†Ô∏è ATEN√á√ÉO:** Restaurar schema `auth` pode quebrar integra√ß√µes do Supabase!

---

### Erro: "invalid byte sequence for encoding UTF8"

**Causa:** Problemas de encoding entre sistemas.

**Solu√ß√£o:**
```batch
@REM Force UTF-8 encoding
psql -h %DB_HOST% -p %DB_PORT% -U %DB_USER% -d %DB_NAME% --set=CLIENT_ENCODING=UTF8 -f backup.sql
```

---

## üîí Seguran√ßa

### ‚ö†Ô∏è AVISOS IMPORTANTES

1. **Senha no Script:**
   - O arquivo `restore.bat` cont√©m a senha do banco em texto plano
   - **NUNCA** commite este arquivo no Git
   - Mantenha em local seguro
   - Considere usar `.pgpass` ou vari√°veis de ambiente

2. **Dados Sens√≠veis:**
   - `auth_data_*.sql` cont√©m senhas hasheadas de usu√°rios
   - `meguispet_data_*.sql` pode conter CPF, CNPJ, emails, telefones
   - Armazene backups em local criptografado
   - Limite acesso apenas a pessoal autorizado

3. **Schema Auth:**
   - Restaurar `schema auth` pode invalidar todas as sess√µes ativas
   - Usu√°rios podem precisar fazer logout/login novamente
   - Tokens de autentica√ß√£o podem ser invalidados

4. **Produ√ß√£o vs Desenvolvimento:**
   - Nunca restaure dados de produ√ß√£o diretamente em produ√ß√£o sem testar antes
   - Sempre teste restores em ambiente de staging primeiro
   - Mantenha backups separados por ambiente

---

## üìù Boas Pr√°ticas

### 1. Antes de Restaurar
- [ ] Fa√ßa um backup do estado atual antes de restaurar
- [ ] Verifique se o backup a ser restaurado n√£o est√° corrompido
- [ ] Confirme que est√° restaurando no ambiente correto
- [ ] Notifique a equipe (se for produ√ß√£o)

### 2. Durante o Restore
- [ ] Monitore logs de erro
- [ ] Verifique o progresso
- [ ] Tenha um plano de rollback

### 3. Ap√≥s o Restore
- [ ] Verifique contagem de registros nas tabelas principais
- [ ] Teste login de usu√°rios
- [ ] Verifique integridade referencial
- [ ] Execute queries de valida√ß√£o
- [ ] Monitore logs da aplica√ß√£o

---

## üìû Suporte

- **Supabase Dashboard:** https://supabase.com/dashboard
- **Documenta√ß√£o PostgreSQL:** https://www.postgresql.org/docs/
- **Supabase Docs - Backups:** https://supabase.com/docs/guides/platform/backups

---

## üìú Hist√≥rico de Altera√ß√µes

| Data | Vers√£o | Descri√ß√£o |
|------|--------|-----------|
| 2025-01-29 | 1.0.0 | Cria√ß√£o do guia de restore completo |

---

**‚úÖ Lembre-se:** Um restore bem-sucedido come√ßa com um backup confi√°vel. Sempre teste seus backups periodicamente!
