# Twin Development Plan (Econômico)
Generated: 2025-10-22
Task: Refatorar projeto para deploy no Vercel com Supabase ao invés de Hostinger com PHP/MariaDB
Quality Level: pragmatic

## Análise Rápida

**Estado Atual:** Projeto Next.js com static export (`output: 'export'`) usando 24 endpoints PHP e MariaDB. Build copia PHP para pasta dist. Services TypeScript chamam endpoints `.php`.

**Mudança Necessária:** Migrar para Vercel com Next.js API routes (Node.js server), substituindo PHP por TypeScript e MariaDB por Supabase PostgreSQL. Mover arquivos obsoletos para pasta `antigos/`.

## Plano de Implementação

### Arquivos a Criar:

**Supabase Client & Utils:**
- `lib/supabase.ts` - Supabase client singleton
- `lib/jwt-utils.ts` - JWT verify/sign utilities

**Next.js API Routes (24 routes):**
- `pages/api/auth.ts` - POST login, GET profile
- `pages/api/clientes.ts` - CRUD clientes
- `pages/api/produtos.ts` - CRUD produtos + stock
- `pages/api/vendas.ts` - CRUD vendas
- `pages/api/fornecedores.ts` - CRUD fornecedores
- `pages/api/vendedores.ts` - CRUD vendedores
- `pages/api/usuarios.ts` - CRUD usuários
- `pages/api/movimentacoes.ts` - CRUD movimentações
- `pages/api/transacoes.ts` - CRUD transações
- `pages/api/estoques.ts` - CRUD estoques
- `pages/api/formas_pagamento.ts` - CRUD formas pagamento
- `pages/api/estoque-relatorio.ts` - Relatório
- `pages/api/historico-precos.ts` - Histórico
- `pages/api/dashboard/metrics.ts` - Dashboard metrics
- `pages/api/dashboard/recent-sales.ts` - Recent sales
- `pages/api/dashboard/top-products.ts` - Top products
- `pages/api/dashboard/vendas-7-dias.ts` - Vendas 7 dias
- `pages/api/health.ts` - Health check

**Database:**
- `database/supabase_schema.sql` - Schema PostgreSQL

### Arquivos a Modificar:

- `next.config.js` - Remover `output: 'export'`, `distDir: 'out'`, `trailingSlash`
- `package.json` - Adicionar `@supabase/supabase-js`, atualizar scripts build
- `services/api.ts` - Remover `.php` de todos endpoints
- `.env.local` - Adicionar vars Supabase, remover vars MariaDB
- `.gitignore` - Remover `out/`, adicionar `.vercel/`

### Arquivos/Pastas a Mover para `/antigos/`:

- `api/` (toda pasta PHP - 24 arquivos)
- `database/*.sql` (schemas MariaDB)
- `database/config.php` (se existir)
- `scripts/build.js` (build custom)
- `.github/workflows/*.yml` (se tiver deploy Hostinger)

### Passos:

**Fase 1 - Setup Supabase:**
1. Instalar dependency: `pnpm add @supabase/supabase-js`
2. Criar `lib/supabase.ts` com client
3. Criar `lib/jwt-utils.ts` com funções JWT
4. Converter schema MariaDB → PostgreSQL em `database/supabase_schema.sql`

**Fase 2 - API Routes Core:**
5. Criar estrutura `/pages/api/` com pastas
6. Implementar `pages/api/auth.ts` (CRÍTICO primeiro)
7. Implementar CRUD: clientes, produtos, vendas
8. Implementar CRUD: fornecedores, vendedores, usuários
9. Implementar estoque: movimentacoes, estoques, estoque-relatorio

**Fase 3 - Dashboard & Extras:**
10. Implementar `pages/api/dashboard/*.ts` (4 endpoints)
11. Implementar transações, historico-precos, formas_pagamento
12. Implementar health check

**Fase 4 - Frontend Update:**
13. Atualizar `services/api.ts` - remover `.php`
14. Atualizar `next.config.js`
15. Atualizar `package.json`
16. Atualizar `.env.local`

**Fase 5 - Cleanup:**
17. Criar pasta `antigos/`
18. Mover `api/`, `database/`, `scripts/build.js`
19. Atualizar `.gitignore`
20. Testar: `pnpm build && pnpm start`

### ⚠️ Riscos:

- **Schema Migration:** AUTO_INCREMENT → SERIAL, ENUM → CHECK constraints, triggers diferentes
- **Autenticação:** ~~JWT_SECRET~~ → **Supabase Auth** (JWT gerenciado automaticamente, sem secrets hardcoded)
- **Tokens:** Access tokens curtos (1h) com refresh automático
- **User Management:** Mantém tabela `usuarios` para metadados da aplicação
- **Decimal Fields:** Usar `parseFloat()` consistente para campos monetários
- **Timezone:** PostgreSQL usa `timestamptz`, garantir UTC

## Próximo Passo
Digite: ok, continue, ou approve
